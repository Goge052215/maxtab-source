<template>
  <div class="container">
    <div class="top-bar">
      <text class="back-button" onclick="goBack">è¿”å›</text>
      <text class="page-title">è®¡ç®—å†å²</text>
      <text class="clear-button" onclick="clearHistory">æ¸…ç©º</text>
    </div>

    <div class="content">
      <div class="stats-card" if="history.length > 0">
        <text class="stats-title">ç»Ÿè®¡ä¿¡æ¯</text>
        <div class="stats-grid">
          <div class="stat-item">
            <text class="stat-value">{{ history.length }}</text>
            <text class="stat-label">æ€»è®¡ç®—æ¬¡æ•°</text>
          </div>
          <div class="stat-item">
            <text class="stat-value">{{ getMostUsedDistribution() }}</text>
            <text class="stat-label">æœ€å¸¸ç”¨åˆ†å¸ƒ</text>
          </div>
          <div class="stat-item">
            <text class="stat-value">{{ getTodayCalculations() }}</text>
            <text class="stat-label">ä»Šæ—¥è®¡ç®—</text>
          </div>
        </div>
      </div>

      <div class="empty-state" if="history.length === 0">
        <text class="empty-icon">ğŸ“Š</text>
        <text class="empty-title">æš‚æ— è®¡ç®—å†å²</text>
        <text class="empty-desc">å¼€å§‹è®¡ç®—åï¼Œå†å²è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</text>
      </div>

      <div class="history-list" if="history.length > 0">
        <div class="history-item" for="{{ item in history }}">
          <div class="item-header">
            <text class="item-title">{{ item.distributionName }}</text>
            <text class="item-time">{{ item.time }}</text>
          </div>
          <div class="item-params">
            <text class="param-text" for="{{ param in item.parameters }}">
              {{ param.name }}={{ param.value }}</text>
          </div>
          <div class="item-results">
            <div class="result-cell">
              <text class="result-label">è¾“å…¥å€¼:</text>
              <text class="result-value">{{ item.inputValue }}</text>
            </div>
            <div class="result-cell">
              <text class="result-label">{{ item.densityLabel }}:</text>
              <text class="result-value">{{ item.densityValue }}</text>
            </div>
            <div class="result-cell">
              <text class="result-label">ç´¯ç§¯æ¦‚ç‡:</text>
              <text class="result-value">{{ item.cdfValue }}</text>
            </div>
          </div>
          <div class="reuse-button" onclick="reuseCalculation($idx)">
            <text class="reuse-text">å¤ç”¨</text>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import router from "@system.router"

export default {
  private: {
    history: []
  },

  onInit() {
    this.$page.setTitleBar({ text: 'è®¡ç®—å†å²' })
    this.loadHistory()
  },

  onShow() {
    this.loadHistory()
  },

  loadHistory() {
    // æ¨¡æ‹ŸåŠ è½½å†å²æ•°æ®
    this.history = [
      {
        distributionName: 'æ­£æ€åˆ†å¸ƒ',
        distributionType: 'normal',
        category: 'continuous',
        time: 'ä»Šå¤© 14:30',
        parameters: [
          { name: 'Î¼', value: 0 },
          { name: 'Ïƒ', value: 1 }
        ],
        inputValue: 1.96,
        densityLabel: 'æ¦‚ç‡å¯†åº¦',
        densityValue: '0.0584',
        cdfValue: '0.9750'
      },
      {
        distributionName: 'äºŒé¡¹åˆ†å¸ƒ',
        distributionType: 'binomial',
        category: 'discrete',
        time: 'ä»Šå¤© 10:15',
        parameters: [
          { name: 'n', value: 20 },
          { name: 'p', value: 0.3 }
        ],
        inputValue: 5,
        densityLabel: 'æ¦‚ç‡è´¨é‡',
        densityValue: '0.1789',
        cdfValue: '0.4164'
      },
      {
        distributionName: 'æ³Šæ¾åˆ†å¸ƒ',
        distributionType: 'poisson',
        category: 'discrete',
        time: 'æ˜¨å¤© 16:45',
        parameters: [
          { name: 'Î»', value: 2.5 }
        ],
        inputValue: 3,
        densityLabel: 'æ¦‚ç‡è´¨é‡',
        densityValue: '0.2138',
        cdfValue: '0.7576'
      },
      {
        distributionName: 'æŒ‡æ•°åˆ†å¸ƒ',
        distributionType: 'exponential',
        category: 'continuous',
        time: 'æ˜¨å¤© 09:20',
        parameters: [
          { name: 'Î»', value: 1.5 }
        ],
        inputValue: 2,
        densityLabel: 'æ¦‚ç‡å¯†åº¦',
        densityValue: '0.3347',
        cdfValue: '0.9502'
      }
    ]
  },

  goBack() {
    router.back()
  },

  clearHistory() {
    this.history = []
    // å®é™…åº”ç”¨ä¸­åº”è¯¥æ¸…é™¤å­˜å‚¨çš„å†å²æ•°æ®
  },

  reuseCalculation(index) {
    const item = this.history[index]
    // å°†å‚æ•°ä¼ é€’åˆ°è®¡ç®—å™¨é¡µé¢
    router.push({
      uri: '/pages/calculator/calculator',
      params: {
        category: item.category,
        distribution: item.distributionType,
        parameters: item.parameters,
        inputValue: item.inputValue
      }
    })
  },

  getMostUsedDistribution() {
    if (this.history.length === 0) return '-'
    
    const counts = {}
    this.history.forEach(item => {
      counts[item.distributionName] = (counts[item.distributionName] || 0) + 1
    })
    
    return Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b)
  },

  getTodayCalculations() {
    // ç®€åŒ–çš„ä»Šæ—¥è®¡ç®—ç»Ÿè®¡
    return this.history.filter(item => item.time.includes('ä»Šå¤©')).length
  }
}
</script>

<style>
.container {
  flex-direction: column;
  background-color: #000000;
  height: 100%;
}

.top-bar {
  height: 70px;
  background-color: #111111;
  flex-direction: row;
  align-items: center;
  padding: 0 20px;
  border-bottom: 1px solid #333333;
}

.back-button {
  font-size: 16px;
  color: #ffffff;
  padding: 10px 15px;
}

.page-title {
  font-size: 20px;
  color: #ffffff;
  font-weight: bold;
  margin-left: 20px;
  flex: 1;
}

.clear-button {
  font-size: 14px;
  color: #ff4444;
  padding: 8px 12px;
}

.content {
  flex: 1;
  flex-direction: column;
  padding: 20px;
}

.stats-card {
  background-color: #222222;
  border: 1px solid #444444;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.stats-title {
  font-size: 16px;
  color: #ffffff;
  font-weight: bold;
  margin-bottom: 15px;
}

.stats-grid {
  flex-direction: row;
  justify-content: space-between;
}

.stat-item {
  flex: 1;
  flex-direction: column;
  align-items: center;
}

.stat-value {
  font-size: 20px;
  color: #00ff00;
  font-weight: bold;
  margin-bottom: 5px;
}

.stat-label {
  font-size: 12px;
  color: #cccccc;
}

.empty-state {
  flex: 1;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.empty-icon {
  font-size: 48px;
  margin-bottom: 20px;
}

.empty-title {
  font-size: 18px;
  color: #ffffff;
  margin-bottom: 10px;
}

.empty-desc {
  font-size: 14px;
  color: #cccccc;
}

.history-list {
  flex-direction: column;
}

.history-item {
  background-color: #222222;
  border: 1px solid #444444;
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 15px;
  flex-direction: column;
}

.item-header {
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}

.item-title {
  font-size: 16px;
  color: #ffffff;
  font-weight: bold;
}

.item-time {
  font-size: 12px;
  color: #cccccc;
}

.item-params {
  flex-direction: row;
  flex-wrap: wrap;
  margin-bottom: 12px;
}

.param-text {
  font-size: 12px;
  color: #aaaaaa;
  margin-right: 10px;
  margin-bottom: 2px;
}

.item-results {
  flex-direction: row;
  justify-content: space-between;
  margin-bottom: 10px;
}

.result-cell {
  flex-direction: column;
  align-items: center;
  flex: 1;
}

.result-label {
  font-size: 11px;
  color: #cccccc;
  margin-bottom: 2px;
}

.result-value {
  font-size: 14px;
  color: #00ff00;
  font-weight: bold;
}

.reuse-button {
  height: 35px;
  background-color: #0066cc;
  border: none;
  border-radius: 8px;
  margin-top: 10px;
  justify-content: center;
  align-items: center;
}

.reuse-text {
  font-size: 14px;
  color: #ffffff;
  font-weight: bold;
}
</style>